<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>图书管理系统 - 首页</title>
    <link rel="stylesheet" href="/static/home.css">
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav id="mainNav">
        <ul class="nav-list">
            <li class="welcome-msg">👤 {{ username }}</li>
            <li><a href="home.html">首页</a></li>
            <li><a href="info.html">个人中心</a></li>
            <!-- 管理员专属菜单 -->
            <li class="admin-only"><a href="manage.html">管理中心</a></li>
            <li class="logout"><a href="login.html">退出登录</a></li>
        </ul>
    </nav>

    <!-- 主要内容区 -->
    <main class="container">
        <div class="books-grid">
            {% for book in books %}
            <div class="book-card" data-book-id="{{ book.book_id }}">
                <h3>{{ book.title }}</h3>
                <div class="book-meta">
                    <span class="stock">剩余：{{ book.remain }}本</span>
                    <span class="type">类型：{{ book.categories }}</span>
                </div>
                <div class="book-actions">
                    <button class="btn add-to-cart">加入借书车</button>
                    <button class="btn borrow-now">立即借阅</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <!-- 借书车侧边栏 -->
    <aside id="cartSidebar">
        <div class="cart-header">
            <h3>借书车 (0)</h3>
            <button class="close-cart">&times;</button>
        </div>
        <ul class="cart-items"></ul>
        <button class="btn checkout-btn">立即借阅</button>
    </aside>

    <!-- 购物车触发按钮 -->
    <button id="cartToggle" class="cart-toggle">🛒 0</button>

    <script>
        // 用户角色模拟（正式环境应从后端获取）
        const isAdmin = localStorage.getItem('isAdmin') === 'true';

        // 初始化导航栏
        function initNav() {
            const adminItems = document.querySelectorAll('.admin-only');
            adminItems.forEach(item => item.style.display = isAdmin ? 'block' : 'none');
        }

        // 借书车功能
        let cartItems = [];
        const cartToggle = document.getElementById('cartToggle');
        const cartSidebar = document.getElementById('cartSidebar');

        function updateCart() {
            cartToggle.textContent = `🛒 ${cartItems.length}`;
            const cartList = document.querySelector('.cart-items');
            cartList.innerHTML = cartItems.map(item => `
                <li>${item} <button class="remove-item">×</button></li>
            `).join('');

            // 添加删除功能
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = [...btn.parentNode.parentNode.children].indexOf(btn.parentNode);
                    cartItems.splice(index, 1);
                    updateCart();
                });
            });
        }

        // 侧边栏切换
        document.getElementById('cartToggle').addEventListener('click', () => {
            cartSidebar.classList.toggle('active');
        });

        document.querySelector('.close-cart').addEventListener('click', () => {
            cartSidebar.classList.remove('active');
        });

        // 初始化
        initNav();

        // 统一校验函数
        async function checkBookAvailability(bookId, actionType) {
            try {
                const response = await fetch('/check_book', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        book_id: bookId,
                        action: actionType
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    showAlert(result.message, 'error');
                    return false;
                }
                return true;

            } catch (error) {
                showAlert('网络错误，请检查连接', 'error');
                return false;
            }
        }

        // 显示提示框
        function showAlert(message, type='info') {
            const alertBox = document.createElement('div');
            alertBox.className = `alert ${type}`;
            alertBox.innerHTML = `
                ${message}
                <span class="close-btn">&times;</span>
            `;

            document.body.appendChild(alertBox);

            // 自动消失
            setTimeout(() => {
                alertBox.remove();
            }, 3000);

            // 手动关闭
            alertBox.querySelector('.close-btn').onclick = () => alertBox.remove();
        }

        // 修改借书车添加逻辑
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', async () => {
                const bookCard = btn.closest('.book-card');
                const bookId = bookCard.dataset.bookId; // 需要先为卡片添加data属性

                const isAvailable = await checkBookAvailability(bookId, 'add_to_cart');
                if (!isAvailable) return;

                const bookTitle = bookCard.querySelector('h3').textContent;
                cartItems.push(bookTitle);
                updateCart();
                showAlert('成功加入借书车', 'success');
            });
        });

        // 修改立即借阅逻辑
        document.querySelectorAll('.borrow-now').forEach(btn => {
            btn.addEventListener('click', async () => {
                const bookCard = btn.closest('.book-card');
                const bookId = bookCard.dataset.bookId;

                const isAvailable = await checkBookAvailability(bookId, 'borrow');
                if (!isAvailable) return;

                // 执行借阅逻辑
                showAlert('借阅申请已提交', 'success');
            });
        });
        // 修改立即借阅按钮事件处理
        document.querySelectorAll('.borrow-now').forEach(btn => {
            btn.addEventListener('click', async () => {
                const bookCard = btn.closest('.book-card');
                const bookId = bookCard.dataset.bookId;

                try {
                    // 第一步：检查余量
                    const checkResponse = await fetch('/check_book', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            book_id: bookId,
                            action: 'borrow'
                        })
                    });

                    if (!checkResponse.ok) {
                        const error = await checkResponse.json();
                        throw new Error(error.message);
                    }

                    // 第二步：执行借阅
                    const borrowResponse = await fetch('/borrow', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ book_id: bookId })
                    });

                    const result = await borrowResponse.json();

                    if (result.success) {
                        showAlert('✅ 借阅成功，3秒后刷新页面', 'success');
                        setTimeout(() => location.reload(), 3000);
                    } else {
                        showAlert(`❌ 借阅失败：${result.message}`, 'error');
                    }

                } catch (error) {
                    showAlert(`❌ 操作失败：${error.message}`, 'error');
                }
            });
        });

    </script>

</body>
</html>
