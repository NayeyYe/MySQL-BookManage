<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ - é¦–é¡µ</title>
    <link rel="stylesheet" href="/static/home.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav id="mainNav">
        <ul class="nav-list">
            <li class="welcome-msg">ğŸ‘¤ {{ username }}</li>
            <li><a href="home.html">é¦–é¡µ</a></li>
            <li><a href="info.html">ä¸ªäººä¸­å¿ƒ</a></li>
            <!-- ç®¡ç†å‘˜ä¸“å±èœå• -->
            <li class="admin-only"><a href="manage.html">ç®¡ç†ä¸­å¿ƒ</a></li>
            <li class="logout"><a href="login.html">é€€å‡ºç™»å½•</a></li>
        </ul>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <main class="container">
        <div class="books-grid">
            {% for book in books %}
            <div class="book-card" data-book-id="{{ book.book_id }}">
                <h3>{{ book.title }}</h3>
                <div class="book-meta">
                    <span class="stock">å‰©ä½™ï¼š{{ book.remain }}æœ¬</span>
                    <span class="type">ç±»å‹ï¼š{{ book.categories }}</span>
                </div>
                <div class="book-actions">
                    <button class="btn add-to-cart">åŠ å…¥å€Ÿä¹¦è½¦</button>
                    <button class="btn borrow-now">ç«‹å³å€Ÿé˜…</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <!-- å€Ÿä¹¦è½¦ä¾§è¾¹æ  -->
    <aside id="cartSidebar">
        <div class="cart-header">
            <h3>å€Ÿä¹¦è½¦ (0)</h3>
            <button class="close-cart">&times;</button>
        </div>
        <ul class="cart-items"></ul>
        <button class="btn checkout-btn">ç«‹å³å€Ÿé˜…</button>
    </aside>

    <!-- è´­ç‰©è½¦è§¦å‘æŒ‰é’® -->
    <button id="cartToggle" class="cart-toggle">ğŸ›’ 0</button>

    <script>
        // ç”¨æˆ·è§’è‰²æ¨¡æ‹Ÿï¼ˆæ­£å¼ç¯å¢ƒåº”ä»åç«¯è·å–ï¼‰
        const isAdmin = localStorage.getItem('isAdmin') === 'true';

        // åˆå§‹åŒ–å¯¼èˆªæ 
        function initNav() {
            const adminItems = document.querySelectorAll('.admin-only');
            adminItems.forEach(item => item.style.display = isAdmin ? 'block' : 'none');
        }

        // å€Ÿä¹¦è½¦åŠŸèƒ½
        let cartItems = [];
        const cartToggle = document.getElementById('cartToggle');
        const cartSidebar = document.getElementById('cartSidebar');

        function updateCart() {
            cartToggle.textContent = `ğŸ›’ ${cartItems.length}`;
            const cartList = document.querySelector('.cart-items');
            cartList.innerHTML = cartItems.map(item => `
                <li>${item} <button class="remove-item">Ã—</button></li>
            `).join('');

            // æ·»åŠ åˆ é™¤åŠŸèƒ½
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = [...btn.parentNode.parentNode.children].indexOf(btn.parentNode);
                    cartItems.splice(index, 1);
                    updateCart();
                });
            });
        }

        // ä¾§è¾¹æ åˆ‡æ¢
        document.getElementById('cartToggle').addEventListener('click', () => {
            cartSidebar.classList.toggle('active');
        });

        document.querySelector('.close-cart').addEventListener('click', () => {
            cartSidebar.classList.remove('active');
        });

        // åˆå§‹åŒ–
        initNav();

        // ç»Ÿä¸€æ ¡éªŒå‡½æ•°
        async function checkBookAvailability(bookId, actionType) {
            try {
                const response = await fetch('/check_book', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        book_id: bookId,
                        action: actionType
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    showAlert(result.message, 'error');
                    return false;
                }
                return true;

            } catch (error) {
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
                return false;
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¡†
        function showAlert(message, type='info') {
            const alertBox = document.createElement('div');
            alertBox.className = `alert ${type}`;
            alertBox.innerHTML = `
                ${message}
                <span class="close-btn">&times;</span>
            `;

            document.body.appendChild(alertBox);

            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                alertBox.remove();
            }, 3000);

            // æ‰‹åŠ¨å…³é—­
            alertBox.querySelector('.close-btn').onclick = () => alertBox.remove();
        }

        // ä¿®æ”¹å€Ÿä¹¦è½¦æ·»åŠ é€»è¾‘
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', async () => {
                const bookCard = btn.closest('.book-card');
                const bookId = bookCard.dataset.bookId; // éœ€è¦å…ˆä¸ºå¡ç‰‡æ·»åŠ dataå±æ€§

                const isAvailable = await checkBookAvailability(bookId, 'add_to_cart');
                if (!isAvailable) return;

                const bookTitle = bookCard.querySelector('h3').textContent;
                cartItems.push(bookTitle);
                updateCart();
                showAlert('æˆåŠŸåŠ å…¥å€Ÿä¹¦è½¦', 'success');
            });
        });

        // ä¿®æ”¹ç«‹å³å€Ÿé˜…é€»è¾‘
        document.querySelectorAll('.borrow-now').forEach(btn => {
            btn.addEventListener('click', async () => {
                const bookCard = btn.closest('.book-card');
                const bookId = bookCard.dataset.bookId;

                const isAvailable = await checkBookAvailability(bookId, 'borrow');
                if (!isAvailable) return;

                // æ‰§è¡Œå€Ÿé˜…é€»è¾‘
                showAlert('å€Ÿé˜…ç”³è¯·å·²æäº¤', 'success');
            });
        });
        // ä¿®æ”¹ç«‹å³å€Ÿé˜…æŒ‰é’®äº‹ä»¶å¤„ç†
        document.querySelectorAll('.borrow-now').forEach(btn => {
            btn.addEventListener('click', async () => {
                const bookCard = btn.closest('.book-card');
                const bookId = bookCard.dataset.bookId;

                try {
                    // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ä½™é‡
                    const checkResponse = await fetch('/check_book', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            book_id: bookId,
                            action: 'borrow'
                        })
                    });

                    if (!checkResponse.ok) {
                        const error = await checkResponse.json();
                        throw new Error(error.message);
                    }

                    // ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œå€Ÿé˜…
                    const borrowResponse = await fetch('/borrow', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ book_id: bookId })
                    });

                    const result = await borrowResponse.json();

                    if (result.success) {
                        showAlert('âœ… å€Ÿé˜…æˆåŠŸï¼Œ3ç§’ååˆ·æ–°é¡µé¢', 'success');
                        setTimeout(() => location.reload(), 3000);
                    } else {
                        showAlert(`âŒ å€Ÿé˜…å¤±è´¥ï¼š${result.message}`, 'error');
                    }

                } catch (error) {
                    showAlert(`âŒ æ“ä½œå¤±è´¥ï¼š${error.message}`, 'error');
                }
            });
        });

    </script>

</body>
</html>
